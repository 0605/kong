#!/usr/bin/env lua

local utils = require "scripts.utils"

-- Load configuration
local opts = {}
opts.conf = utils.getopt(arg, "conf").conf
opts.drop = utils.getopt(arg, "drop").drop
opts.silent = utils.getopt(arg, "s").s
opts.random = utils.getopt(arg, "random").random

local configuration = sutils.load_configuration(opts.conf)
local dao_configuration = configuration.databases_available[configuration.database]

if not dao_configuration then
  error("No dao \""..configuration.database.."\" defined in "..opts.conf)
end

-- Load DAO
local dao_factory = require("apenode.dao."..configuration.database..".factory")
local dao = dao_factory(dao_configuration.properties)

-- Drop if exists
dao:drop()

if not opts.silent then
  print(utils.green("✔").." Dropped")
end

if not opts.drop then
  dao:populate(opts.random)
end

if not opts.silent then
  print(utils.green("✔").." Populated")
end

dao:close()
