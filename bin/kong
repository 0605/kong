#!/bin/sh

SCRIPT_DIR="$( cd "$( dirname "$0" )" && pwd )"
KONG_DIR="$(echo $SCRIPT_DIR | sed -e 's/\/[^\/]*$//')"
KONG_CONF=$KONG_DIR/nginx/kong.conf

DAEMON="off"
LUA_LIB=""
LUA_CODE_CACHE="on"
KONG_PORT="8000"
KONG_ADMIN_PORT="8001"

function show_help {
  echo $"Usage: $0 {start|stop|restart}"
  exit 1
}

function start {
  echo "Starting Kong"

  mkdir -p $KONG_DIR/nginx/logs
  touch $KONG_DIR/nginx/logs/error.log
  touch $KONG_DIR/nginx/logs/access.log
  cp -n $KONG_DIR/templates/kong.conf $KONG_DIR/nginx/kong.conf
  sed \
    -e "s/{{DAEMON}}/$DAEMON/g" \
    -e "s@{{LUA_LIB_PATH}}@$LUA_LIB@g" \
    -e "s/{{LUA_CODE_CACHE}}/$LUA_CODE_CACHE/g" \
    -e "s/{{PORT}}/$KONG_PORT/g" \
    -e "s/{{WEB_PORT}}/$KONG_ADMIN_PORT/g" \
    -e "s@{{KONG_CONF}}@$KONG_CONF@g" \
    $KONG_DIR/templates/nginx.conf > $KONG_DIR/nginx/nginx.conf;

  nginx -p $KONG_DIR/nginx -c $KONG_DIR/nginx/nginx.conf
}

function stop {
  echo "Stopping Kong"
  kill $(cat /var/run/nginx.pid)
}

function restart {
  stop
  start
}

OPTIND=1 # Reset in case getopts has been used previously in the shell.

cmd=""

while getopts "h?v:" opt; do
    case "$opt" in
    h|\?)
        show_help
        exit 0
        ;;
    v)  version=1
        ;;
    esac
done

shift $((OPTIND-1))

[ "$1" = "--" ] && shift

if [ $version ]; then
  echo "Kong Version 0.1"
  exit 0;
fi

case "$@" in
  start)
      start
      ;;

  stop)
      stop
      ;;

  restart)
      restart
      ;;

  *)
      show_help

esac

# End of file